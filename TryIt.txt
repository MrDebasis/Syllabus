Final Answers JSON: [{"UniqueId":"Apheresis_500KS000001cW76YAE_Q1","label":"When is the apheresis appointment date for Order # ORD123?*","value":"2025-05-02"},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q2","label":"What day should the patient arrive for their apheresis appointment?*","value":"2025-05-02"},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q3","label":"What day should the patient depart?*","value":"2025-05-02"},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q4","label":"Are the dates provided related to CARVYKTIÂ® treatment?*","value":"Yes"},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q5","label":"Will the patient receive bridging therapy at your certified treatment center?*","value":"Yes"},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q6_Arrival_1","label":"When should we check back in to confirm if bridging therapy will be needed?* - Arrival","value":"2025-05-01","priority":1},{"UniqueId":"Apheresis_500KS000001cW76YAE_Q6_Departure_1","label":"When should we check back in to confirm if bridging therapy will be needed?* - Departure","value":"2025-05-02","priority":1}]

Error processing milestone data: Attempt to de-reference a null object'
handleSave() {
    const jsonString = JSON.stringify(this.answers);
    console.log( 'Final Answers JSON:', jsonString);
        upsertMilestones({ payloadJson: jsonString, caseId: this.caseId, surveyType: this.surveyType })
            .then(() => {
                console.log('Milestones upserted successfully.');
            })
            .catch(error => {
                console.error('Error upserting milestones:', error);
            });
    }

  @AuraEnabled
    public static void upsertMilestones(String payloadJson, Id caseId, String surveyType) {
        try {
            List<MilestoneWrapper> incomingList = (List<MilestoneWrapper>) JSON.deserialize(payloadJson, List<MilestoneWrapper>.class);

            Set<String> uniqueIds = new Set<String>();
            for (MilestoneWrapper wrap : incomingList) {
                uniqueIds.add(wrap.UniqueId);
            }

            // Get record type ID
            Id recordTypeId = Schema.SObjectType.PatientSupportMilestone__c
                .getRecordTypeInfosByName()
                .get('PatientPortalSurvey')
                .getRecordTypeId();

            // Query existing milestones
            Map<String, PatientSupportMilestone__c> existingMap = new Map<String, PatientSupportMilestone__c>();
            for (PatientSupportMilestone__c ms : [
                SELECT Id, UniqueId__c 
                FROM PatientSupportMilestone__c 
                WHERE Case__c = :caseId 
                AND SurveyType__c = :surveyType 
                AND UniqueId__c IN :uniqueIds
            ]) {
                existingMap.put(ms.UniqueId__c, ms);
            }

            List<PatientSupportMilestone__c> recordsToUpsert = new List<PatientSupportMilestone__c>();

            for (MilestoneWrapper wrapper : incomingList) {
                PatientSupportMilestone__c record;

                if (existingMap.containsKey(wrapper.UniqueId)) {
                    record = existingMap.get(wrapper.UniqueId);
                } else {
                    record = new PatientSupportMilestone__c();
                    record.Case__c = caseId;
                    record.SurveyType__c = surveyType;
                    record.UniqueId__c = wrapper.UniqueId;
                    record.RecordTypeId = recordTypeId;
                }

                // Overwrite values from incoming payload
                record.Question__c = wrapper.label;
                record.SurveyStatus__c = 'Completed';

                if (String.isNotBlank(wrapper.priority)) {
                    record.Priority__c =wrapper.priority;
                    record.QuestionValue__c = null;

                    if (wrapper.label != null && wrapper.label.toLowerCase().contains('arrival')) {
                        record.ArrivalDate__c = Date.valueOf(wrapper.value);
                        record.DepartureDate__c = null;
                    } else if (wrapper.label != null && wrapper.label.toLowerCase().contains('departure')) {
                        record.DepartureDate__c = Date.valueOf(wrapper.value);
                        record.ArrivalDate__c = null;
                    }
                } else {
                    record.Priority__c = null;
                    record.QuestionValue__c = wrapper.value;
                    record.ArrivalDate__c = null;
                    record.DepartureDate__c = null;
                }

                recordsToUpsert.add(record);
            }

            upsert recordsToUpsert;

        } catch (Exception e) {
            throw new AuraHandledException('Error processing milestone data: ' + e.getMessage());
        }
    }
      public class MilestoneWrapper {
        public String UniqueId;
        public String label;
        public String value;
        public String priority;
    }
