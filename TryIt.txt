import { LightningElement, track } from 'lwc';

const surveyConfig = {
    apheresis: {
        steps: {
            start: {
                type: 'date',
                questions: [
                    { id: 'Q1', label: 'Apheresis appointment date?', type: 'date', required: true },
                    { id: 'Q2', label: 'Patient arrival date?', type: 'date', required: true }
                ],
                next: 'screen2'
            },
            screen2: {
                type: 'yesNo',
                questionId: 'relatedToTreatment',
                label: 'Are the dates related to treatment?',
                required: true,
                options: ['Yes', 'No'],
                next: 'screen3'
            },
            screen3: {
                type: 'multipleChoice',
                questionId: 'bridgingTherapy',
                label: 'Will bridging therapy be provided?',
                required: true,
                options: ['Yes', 'No', 'Not Sure Yet'],
                next: 'end'
            },
            end: {
                type: 'message',
                label: 'Thank you for completing the survey.'
            }
        }
    }
};

export default class PspSurveyLWCComponent extends LightningElement {
    @track currentStep = 'start';
    @track answers = {};
    @track selectedOption = '';
    @track isNextButtonDisabled = true;

    // UI flags
    @track showDateInputs = false;
    @track showYesNo = false;
    @track showMultipleChoice = false;
    @track showMessage = false;

    // Pre-rendered question objects
    @track renderedDateQuestions = [];
    @track renderedYesNoLabel = '';
    @track renderedYesNoOptions = [];
    @track renderedMultipleChoiceLabel = '';
    @track renderedMultipleChoiceOptions = [];
    @track renderedMessageLabel = '';

    connectedCallback() {
        this.updateUIFlags();
    }

    get stepConfig() {
        return surveyConfig.apheresis.steps[this.currentStep];
    }

    updateUIFlags() {
        const step = this.stepConfig;

        // Reset flags
        this.showDateInputs = false;
        this.showYesNo = false;
        this.showMultipleChoice = false;
        this.showMessage = false;
        this.isNextButtonDisabled = true;

        // Reset rendered values
        this.renderedDateQuestions = [];
        this.renderedYesNoLabel = '';
        this.renderedYesNoOptions = [];
        this.renderedMultipleChoiceLabel = '';
        this.renderedMultipleChoiceOptions = [];
        this.renderedMessageLabel = '';

        switch (step.type) {
            case 'date':
                this.showDateInputs = true;
                this.renderedDateQuestions = step.questions.map(q => ({
                    ...q,
                    value: this.answers[q.id] || ''
                }));
                break;
            case 'yesNo':
                this.showYesNo = true;
                this.renderedYesNoLabel = step.label;
                this.renderedYesNoOptions = step.options.map(opt => ({ label: opt, value: opt }));
                break;
            case 'multipleChoice':
                this.showMultipleChoice = true;
                this.renderedMultipleChoiceLabel = step.label;
                this.renderedMultipleChoiceOptions = step.options.map(opt => ({ label: opt, value: opt }));
                break;
            case 'message':
                this.showMessage = true;
                this.renderedMessageLabel = step.label;
                break;
        }

        this.updateNextButtonState();
    }

    handleInputChange(event) {
        const { name, value } = event.target;
        this.answers[name] = value;

        // Update rendered values
        this.renderedDateQuestions = this.renderedDateQuestions.map(q => {
            return q.id === name ? { ...q, value } : q;
        });

        this.updateNextButtonState();
    }

    handleOptionChange(event) {
        this.selectedOption = event.detail.value;
        const step = this.stepConfig;
        this.answers[step.questionId] = this.selectedOption;

        this.updateNextButtonState();
    }

    updateNextButtonState() {
        const step = this.stepConfig;
        switch (step.type) {
            case 'date':
                this.isNextButtonDisabled = !step.questions.every(q => this.answers[q.id]);
                break;
            case 'yesNo':
            case 'multipleChoice':
                this.isNextButtonDisabled = !this.selectedOption;
                break;
            default:
                this.isNextButtonDisabled = false;
        }
    }

    handleNext() {
        this.selectedOption = '';
        this.currentStep = this.stepConfig.next;
        this.updateUIFlags();
    }
}


<template>
    <div class="survey-container">

        <!-- Date Inputs -->
        <template if:true={showDateInputs}>
            <template for:each={renderedDateQuestions} for:item="q">
                <lightning-input
                    key={q.id}
                    type={q.type}
                    name={q.id}
                    label={q.label}
                    value={q.value}
                    onchange={handleInputChange}
                    required={q.required}>
                </lightning-input>
            </template>
        </template>

        <!-- Yes/No -->
        <template if:true={showYesNo}>
            <lightning-radio-group
                label={renderedYesNoLabel}
                name="yesNoGroup"
                options={renderedYesNoOptions}
                value={selectedOption}
                type="radio"
                onchange={handleOptionChange}>
            </lightning-radio-group>
        </template>

        <!-- Multiple Choice -->
        <template if:true={showMultipleChoice}>
            <lightning-radio-group
                label={renderedMultipleChoiceLabel}
                name="multiChoiceGroup"
                options={renderedMultipleChoiceOptions}
                value={selectedOption}
                type="radio"
                onchange={handleOptionChange}>
            </lightning-radio-group>
        </template>

        <!-- Final Message -->
        <template if:true={showMessage}>
            <div class="thank-you">{renderedMessageLabel}</div>
        </template>

        <!-- Navigation -->
        <lightning-button
            variant="brand"
            label="Next"
            onclick={handleNext}
            disabled={isNextButtonDisabled}
            class="slds-m-top_medium">
        </lightning-button>

    </div>
</template>
